{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"ADFName": {
			"type": "string",
			"metadata": {
				"description": "Name for the Data Factory"
			}
		},
		"environment": {
			"type": "string",
			"metadata": {
				"description": "Environment to decide whether to attach repository"
			}
		},
		"keyVaultName": {
			"type": "string",
			"metadata": {
				"description": "Name for an example keyvault"
			},
			"defaultValue": "mostsecurevault"
		},
		"secretName": {
			"type": "string",
			"metadata": {
				"description": "Name for an example secret in key vault"
			},
			"defaultValue": "my--super--secret"
		},
		"ContainerSasToken": {
			"type": "securestring",
			"defaultValue": "",
			"metadata": {
				"description": "SAS token for the container where the templates are, generated by Azure Pipeline"
			}
		},
		"buildtag": {
			"type": "string",
			"defaultValue": "[utcNow()]"
		}
	},
	"variables": {
		"templateUrls": {
			"arm_adf_base": "[concat(uri(deployment().properties.templateLink.uri, 'base.json'), parameters('ContainerSasToken'))]",
			"arm_adf_autogenerated": "[concat(uri(deployment().properties.templateLink.uri, 'ARMTemplateForFactory.json'), parameters('ContainerSasToken'))]",
		}
	},
	"resources": [
		{
			"apiVersion": "2017-05-10",
			"name": "[concat('arm-base-', parameters('environment'),'-', parameters('buildtag'))]",
			"type": "Microsoft.Resources/deployments",
			"properties": {
				"mode": "Incremental",
				"templateLink": {
					"uri": "[variables('templateUrls').arm_adf_base]"
				},
				"parameters": {
					"ADFName": {"value": "[parameters('ADFName')]"},
					"environment": {"value": "[parameters('environment')]"
					}
				}
			}
		},
		{
			"apiVersion": "2017-05-10",
			"condition": "[not(equals(parameters('environment'), 'dev'))]",
			"name": "[concat('arm-adf-autogenerated-', parameters('environment'),'-', parameters('buildtag'))]",
			"type": "Microsoft.Resources/deployments",
			"properties": {
				"mode": "Incremental",
				"templateLink": {
					"uri": "[variables('templateUrls').arm_adf_autogenerated]"
				},
				"parameters": {
					"factoryName": {"value": "[parameters('ADFName')]"},
					"keyvault_properties_typeProperties_baseUrl": {"value": "[concat('https://', parameters('keyVaultName'), '.vault.azure.net/')]"},
					"sqldb_properties_typeProperties_connectionString_secretName": {"value": "[parameters('secretName')]"}
				}
			},
			"dependsOn": [
				"[concat('Microsoft.Resources/deployments/', 'arm-base-', parameters('environment'),'-', parameters('buildtag'))]"
			]
		}
	],
	"outputs": {
	}
}